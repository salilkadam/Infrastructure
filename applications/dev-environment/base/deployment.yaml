apiVersion: apps/v1
kind: Deployment
metadata:
  name: dev-environment
  namespace: dev-environment
  labels:
    app.kubernetes.io/name: dev-environment
    app.kubernetes.io/component: development
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: dev-environment
      app.kubernetes.io/component: development
  template:
    metadata:
      labels:
        app.kubernetes.io/name: dev-environment
        app.kubernetes.io/component: development
    spec:
      containers:
      - name: dev-environment
        image: python:3.11-slim
        command: ["/bin/bash"]
        args: ["-c", "apt-get update && apt-get install -y curl wget git vim nano openssh-server && curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs && pip install psycopg2-binary redis minio boto3 && npm install -g yarn && mkdir -p /root/.ssh && cp /var/run/secrets/kubernetes.io/ssh-keys/id_rsa.pub /root/.ssh/authorized_keys && chmod 600 /root/.ssh/authorized_keys && chmod 700 /root/.ssh && service ssh start && tail -f /dev/null"]
        ports:
        - containerPort: 3000
          name: node
        - containerPort: 8000
          name: python
        - containerPort: 22
          name: ssh
        env:
        - name: POSTGRES_HOST
          value: "pg-rw.postgres.svc.cluster.local"
        - name: POSTGRES_PORT
          value: "5432"
        - name: POSTGRES_DB
          value: "postgres"
        - name: POSTGRES_USER
          value: "postgres"
        - name: POSTGRES_PASSWORD
          value: "postgres_password"
        - name: REDIS_HOST
          value: "redis.redis.svc.cluster.local"
        - name: REDIS_PORT
          value: "6379"
        - name: MINIO_ENDPOINT
          value: "minio-hl.minio.svc.cluster.local:9000"
        - name: MINIO_ACCESS_KEY
          value: "minioadmin"
        - name: MINIO_SECRET_KEY
          value: "minioadmin"
        - name: MINIO_BUCKET
          value: "default"
        resources:
          requests:
            memory: "2Gi"
            cpu: "1000m"
          limits:
            memory: "4Gi"
            cpu: "2000m"
        volumeMounts:
        - name: dev-workspace
          mountPath: /workspace
        - name: ssh-keys
          mountPath: /var/run/secrets/kubernetes.io/ssh-keys
          readOnly: true
      volumes:
      - name: dev-workspace
        persistentVolumeClaim:
          claimName: dev-workspace-pvc
      - name: ssh-keys
        secret:
          secretName: dev-ssh-keys
          defaultMode: 0400 